# Development Dockerfile for Frontend with Vite HMR
FROM node:20-alpine

WORKDIR /app

# Copy package files for dependency installation
COPY package*.json ./
COPY package-lock.json* ./
COPY apps/frontend/package*.json ./apps/frontend/
COPY apps/packages/shared/package*.json ./apps/packages/shared/

# Install all dependencies (including dev dependencies for Vite)
# Use npm install for development (more flexible than npm ci)
RUN npm install --legacy-peer-deps

# Copy TypeScript configs (needed for shared package build)
COPY tsconfig.json ./

# Build shared package first (needed by frontend)
COPY apps/packages/shared/tsconfig.json ./apps/packages/shared/
COPY apps/packages/shared/src ./apps/packages/shared/src
WORKDIR /app/apps/packages/shared
RUN npm run build

# Return to root
WORKDIR /app
COPY apps/frontend/tsconfig.json ./apps/frontend/
COPY apps/frontend/tsconfig.app.json ./apps/frontend/
COPY apps/frontend/tsconfig.node.json ./apps/frontend/
COPY apps/frontend/tsconfig.vitest.json ./apps/frontend/

# Copy Vite config
COPY apps/frontend/vite.config.ts ./apps/frontend/
COPY apps/frontend/index.html ./apps/frontend/

# Copy source code (will be overridden by volume mount, but needed for initial setup)
COPY apps/frontend/src ./apps/frontend/src
COPY apps/frontend/public ./apps/frontend/public

# Expose Vite dev server port
EXPOSE 3000

# Set environment for Vite
ENV NODE_ENV=development

# Run Vite dev server with HMR
# Source code is mounted as volume, so changes will trigger HMR
WORKDIR /app/apps/frontend

# Use sh to run the command to ensure proper execution
CMD ["sh", "-c", "npm run dev -- --host 0.0.0.0 --port 3000"]
